name: Deploy Hugo site

on:
  push:
    branches:
      - main

  # Run every 4 hours (UTC)
  schedule:
    - cron: '0 */4 * * *'

  # Manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------- INSTALL RCLONE ----------
      - name: Install rclone
        run: sudo apt-get update && sudo apt-get install -y rclone

      # ---------- CONFIGURE RCLONE ----------
      - name: Configure rclone (Google Drive)
        run: |
          mkdir -p ~/.config/rclone
      
          # Decode JSON safely
          printf '%s' "${{ secrets.RCLONE_GDRIVE_SA_B64 }}" | base64 -d > ~/.config/rclone/service_account.json
      
          # Validate JSON (very important)
          jq . ~/.config/rclone/service_account.json
      
          # rclone config
          cat <<EOF > ~/.config/rclone/rclone.conf
          [gdrive]
          type = drive
          scope = drive.readonly
          service_account_file = ~/.config/rclone/service_account.json
          EOF


      # ---------- SYNC PHOTOS ----------
      - name: Sync Google Drive photos â†’ Hugo content
        run: |
          mkdir -p content/photos
          rclone sync gdrive:photos content/photos \
            --drive-shared-with-me \
            --ignore-existing \
            --exclude "tokyo-tower.jpg" \
            --exclude "index.md" \
            --progress

      # ---------- COMMIT IF CHANGED ----------
      - name: Commit new photos
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add content/photos
          git diff --cached --quiet || git commit -m "Sync photos from Google Drive"
          git push

      # ---------- HUGO BUILD ----------
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build
        run: hugo --cleanDestinationDir --gc

      # ---------- DEPLOY ----------
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
